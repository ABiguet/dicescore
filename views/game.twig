{% extends 'layout.twig' %}
{% block body %}
	<!-- Header de la partie -->
	<nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-3 rounded">
		<div class="container-fluid">
			<span class="navbar-brand mb-0 h1">
				<i class="bi bi-dice-6 me-2"></i>{{ title }}
			</span>
			<div class="d-flex align-items-center gap-3">
				<button class="btn btn-outline-light btn-sm" id="toggleTotalsBtn" type="button">
					<i class="bi bi-calculator me-1"></i>Afficher les totaux
				</button>
				<a href="/" class="btn btn-light btn-sm">
					<i class="bi bi-arrow-left me-1"></i>Retour menu
				</a>
			</div>
		</div>
	</nav>

	<!-- Totaux (masqués par défaut) -->
	<div id="totalsTableWrapper" class="mb-3" style="display:none;">
		<div class="card">
			<div class="card-header bg-info text-white">
				<i class="bi bi-trophy me-2"></i>Totaux généraux
			</div>
			<div class="card-body">
				<div class="row g-2">
					{% for joueur in joueurs %}
						<div class="col-md-6 col-lg-4">
							<div class="d-flex align-items-center gap-2 p-2 border rounded">
								<div class="color-indicator rounded-circle" style="background: {{ joueur.color }}; width: 20px; height: 20px;"></div>
								<strong>{{ joueur.name }}</strong>
								<input type="number" class="form-control form-control-sm ms-auto" style="width: 80px;" id="total_joueur_{{ loop.index }}_global" name="total_joueur_{{ loop.index }}_global" readonly>
							</div>
						</div>
					{% endfor %}
				</div>
			</div>
		</div>
	</div>
	<!-- Tableau de jeu principal -->
	<div class="game-table-container">
		<table class="table table-bordered table-hover text-center align-middle game-table">
			<thead class="table-dark sticky-top">
				<tr>
					<th class="figure-column">Figures</th>
					{% for joueur in joueurs %}
						{% for col in colonnesParJoueur %}
							<th class="player-column" style="background: {{ joueur.color }}; color: white;">
								<div class="player-header">
									<div class="player-name">{{ joueur.name }}</div>
									{% if col.label %}
										<div class="column-label">{{ col.label|raw }}</div>
									{% endif %}
								</div>
							</th>
						{% endfor %}
					{% endfor %}
				</tr>
			</thead>
			<tbody>
				{% for fig in figures %}
					<tr class="{% if fig.readonly %}table-secondary{% endif %}">
						<td class="figure-label">{{ fig.label|raw }}</td>
						{% for joueur in joueurs %}
							{% for col in colonnesParJoueur %}
								<td class="game-cell">
									{% if fig.fixed is defined and fig.fixed %}
										<div class="checkbox-group">
											<div class="form-check form-check-inline">
												<input class="form-check-input" type="checkbox" name="{{ fig.name }}_{{ loop.parent.loop.index }}_{{ loop.index }}_valide" id="{{ fig.name }}_{{ loop.parent.loop.index }}_{{ loop.index }}_valide" value="{{ fig.fixed }}">
												<label class="form-check-label check-success" for="{{ fig.name }}_{{ loop.parent.loop.index }}_{{ loop.index }}_valide">
													<i class="bi bi-check-circle"></i>
												</label>
											</div>
											<div class="form-check form-check-inline">
												<input class="form-check-input" type="checkbox" name="{{ fig.name }}_{{ loop.parent.loop.index }}_{{ loop.index }}_annule" id="{{ fig.name }}_{{ loop.parent.loop.index }}_{{ loop.index }}_annule" value="0">
												<label class="form-check-label check-danger" for="{{ fig.name }}_{{ loop.parent.loop.index }}_{{ loop.index }}_annule">
													<i class="bi bi-x-circle"></i>
												</label>
											</div>
										</div>
									{% else %}
										{% if fig.multiple %}
											<div class="input-group input-group-sm compact-input">
												<button class="btn btn-outline-danger btn-sm decrement-btn" type="button">
													<i class="bi bi-dash"></i>
												</button>
												<input type="number" class="form-control text-center compact-number" name="{{ fig.name }}_{{ loop.parent.loop.index }}_{{ loop.index }}" id="{{ fig.name }}_{{ loop.parent.loop.index }}_{{ loop.index }}" step="{{ fig.multiple }}" max="{{ fig.multiple * 5 }}">
												<button class="btn btn-outline-success btn-sm increment-btn" type="button">
													<i class="bi bi-plus"></i>
												</button>
											</div>
										{% else %}
											<input type="number" class="form-control compact-number text-center {% if fig.readonly %}readonly-input{% endif %}" name="{{ fig.name }}_{{ loop.parent.loop.index }}_{{ loop.index }}" id="{{ fig.name }}_{{ loop.parent.loop.index }}_{{ loop.index }}" {% if fig.readonly %} readonly {% endif %}>
										{% endif %}
										<label for="{{ fig.name }}_{{ loop.parent.loop.index }}_{{ loop.index }}" class="visually-hidden">{{ fig.label }}
											{{ joueur.name }}
											Colonne
											{{ loop.parent.loop.index }}
										</label>
									{% endif %}
								</td>
							{% endfor %}
						{% endfor %}
					</tr>
				{% endfor %}
			</tbody>
		</table>
	</div>
	<!-- Actions -->
	<div class="d-flex justify-content-between align-items-center mt-3">
		<div class="text-muted small">
			<i class="bi bi-info-circle me-1"></i>
			Utilisez les boutons +/- ou saisissez directement les valeurs
		</div>
		<button class="btn btn-outline-danger" id="resetBtn">
			<i class="bi bi-arrow-clockwise me-1"></i>Reset complet
		</button>
	</div>
	<script type="text/javascript">
		window.yamFigures = {{ figures|json_encode|raw }};
		document.addEventListener('DOMContentLoaded', function () {
			const btn = document.getElementById('toggleTotalsBtn');
			const wrapper = document.getElementById('totalsTableWrapper');
			btn.addEventListener('click', function () {
				if (wrapper.style.display === 'none') {
					wrapper.style.display = '';
					btn.innerHTML = '<i class="bi bi-calculator me-1"></i>Masquer les totaux';
				} else {
					wrapper.style.display = 'none';
					btn.innerHTML = '<i class="bi bi-calculator me-1"></i>Afficher les totaux';
				}
			});
		});
	</script>
	<script type="module" src="/javascripts/yams/main.js"></script>
{% endblock %}
